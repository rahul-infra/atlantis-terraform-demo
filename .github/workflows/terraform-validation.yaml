name: Terraform Validation

on:
  pull_request:
    branches:
      - main
      - master
    paths:
      - 'components/**'
      - '.github/workflows/**'

jobs:
  validate-components:
    name: Validate Terraform Components
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.0.0

      - name: Terraform Format Check
        id: fmt
        run: |
          echo "Checking Terraform formatting..."
          terraform fmt -check -recursive components/
        continue-on-error: true

      - name: Terraform Format Results
        if: steps.fmt.outcome == 'failure'
        run: |
          echo " Terraform formatting issues found!"
          echo "Run 'terraform fmt -recursive components/' to fix"
          exit 1

      - name: Validate Each Component
        run: |
          echo "Validating all Terraform components..."
          VALIDATION_FAILED=0

          for component_dir in components/terraform/*/; do
            if [ -d "$component_dir" ]; then
              component_name=$(basename "$component_dir")
              echo "::group::Validating component: $component_name"

              cd "$component_dir"

              # Initialize Terraform
              if ! terraform init -backend=false; then
                echo " Failed to initialize $component_name"
                VALIDATION_FAILED=1
              fi

              # Validate configuration
              if ! terraform validate; then
                echo " Validation failed for $component_name"
                VALIDATION_FAILED=1
              fi

              # Go back to root
              cd - > /dev/null

              echo "::endgroup::"
            fi
          done

          if [ $VALIDATION_FAILED -eq 1 ]; then
            echo " One or more components failed validation"
            exit 1
          fi

          echo " All components validated successfully!"

      - name: Comment PR (Success)
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '##  Terraform Validation Passed\n\nAll Terraform components have been validated successfully!\n\n- Terraform format: \n- Terraform init: \n- Terraform validate: '
            })

      - name: Comment PR (Failure)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '##  Terraform Validation Failed\n\nPlease check the workflow logs for details.\n\nCommon fixes:\n- Run `terraform fmt -recursive components/` for formatting issues\n- Check Terraform syntax in the workflow logs'
            })
